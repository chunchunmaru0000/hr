пусть __РАЗМЕР_ПЛАСТА: ч64 = 0x10_00_00,
пусть __ПЛАСТ: стр = 0,
пусть __КОНЕЦ_ПЛАСТА: стр = 0,
пусть __ПЛАСТ_ЩАС: стр = 0

фц __АСМ начать_пласт(размер_пласта: ч64) тлен (
_асм "
	плюс вбайт(__РАЗМЕР_ПЛАСТА__ч64) рси
	идти начать_пласт__{тлен}
"
)

фц __АСМ начать_пласт() тлен (
_асм "
	быть рах 9 		; mmap
	искл рди рди	; NULL
	быть рси вбайт(__РАЗМЕР_ПЛАСТА__ч64)
	быть рдх 3 		; READ | WRITE
	быть р10 34 	; PRIVATE | ANON
	искл р8 р8 --р8 ; -1
	искл р9 р9		; 0
	сзов

	; mmap всегда возвращает адрес кратный 4096, а значит и кратный 16
	быть вбайт(__ПЛАСТ__ук_ц8) рах
	быть вбайт(__ПЛАСТ_ЩАС__ук_ц8) рах
	плюс рах вбайт(__РАЗМЕР_ПЛАСТА__ч64)
	быть вбайт(__КОНЕЦ_ПЛАСТА__ук_ц8) рах
"
)

фц __АСМ пластом(размер: ч32) *тлен (
_асм "
	толк р15

	плюс еси 15
	и еси -16 		; выравнивание по 16 байт
	быть р15 еси

	быть рах вбайт(__ПЛАСТ_ЩАС__ук_ц8)
	плюс р15 рах
	срав р15 вбайт(__КОНЕЦ_ПЛАСТА__ук_ц8)
	; нехватка это редкий случай, поэтому прыжок на нехватку
	идб __НЕ_ХВАТАЕТ_МЕСТА_В_ПЛАСТЕ

	быть вбайт(__ПЛАСТ_ЩАС__ук_ц8) р15

	выт р15
	возд

__НЕ_ХВАТАЕТ_МЕСТА_В_ПЛАСТЕ:
	быть р15 еси 	; размер%16 в р15

	; __РАЗМЕР_ПЛАСТА = макс(__РАЗМЕР_ПЛАСТА, размер)
	быть рах вбайт(__РАЗМЕР_ПЛАСТА__ч64)
	сбытьб рах р15
	быть вбайт(__РАЗМЕР_ПЛАСТА__ч64) рах

	зов начать_пласт__{тлен}
	быть рах вбайт(__ПЛАСТ_ЩАС__ук_ц8)
	плюс р15 рах
	быть вбайт(__ПЛАСТ_ЩАС__ук_ц8) р15

	выт р15
"
)

фц __АСМ пере_пласт(адреса: *тлен размером в_размер: ч32) *тлен (
_асм "
	; рси - адреса
	; еди - размером
	; е8  - в_размер
	срав еди е8
	идмр __пере_пласт_ТАКЖЕ

	толк р15
	толк р14

	быть е15 еди ; размером
	быть е14 е8  ; в_размер

	зов пластом__{ч32_ук_тлен}
	

	выт р14
	выт р15
	возд

__пере_пласт_ТАКЖЕ:
	быть рах рси
"
)
